#!/bin/bash

set -e
set -u

#ADD HOST IP, HOST NAME
echo <%= p('hbase.host_ip')%>  <%= p('hbase.host_name')%> >> /etc/hosts

#SET JOB_NAME
export JOB_NAME='webui'

#CALL COMMON
source /var/vcap/jobs/${JOB_NAME}/common/ctl_common.sh ${JOB_NAME}

echo "Starting COMMON INIT ..."
common_init
echo "SUCCESS :: Starting COMMON INIT ..."

case $1 in
  
  start)
    echo "Starting WEBUI ..."

    #SET COMMON START
    common_start
  
    #CHECK WEBUI WAR
    if [ -f ${PKG_DIR}/pinpoint-web-1.6.0-SNAPSHOT.war ]; then
      echo "Checking WAR ..."
      unzip -qq ${PKG_DIR}/pinpoint-web-1.6.0-SNAPSHOT.war -d ${CATALINA_HOME}/webapps/ROOT
      echo "SUCCESS :: Checking WAR ..."
    else
      echo "FAIL :: Checking WAR ..."
      exit 1
    fi
  
    #MODFY HBASE PROPERT
    echo "Modifying HBASE PROPERTY ..."
    sed -i -e s/"hbase.client.host=localhost"/"hbase.client.host=<%= p('hbase.host_name')%>"/g ${CATALINA_HOME}/webapps/ROOT/WEB-INF/classes/hbase.properties
    echo "SUCCESS :: Modifying HBASE PROPERTY ..."
  
    #MODFY WEBUI PROPERT
    echo "Modifying WEBUI PROPERTY ..."
    sed -i -e s/"cluster.zookeeper.address=localhost"/"cluster.zookeeper.address=<%= p('hbase.host_name')%>"/g ${CATALINA_HOME}/webapps/ROOT/WEB-INF/classes/pinpoint-web.properties
    echo "SUCCESS :: Modifying WEBUI PROPERTY ..."
  
    ${CATALINA_HOME}/bin/startup_pinpoint.sh

    echo "SUCCESS :: Starting WEBUI ..."
    ;;
  
  stop)
    echo "Stopping WEBUI ..."
    ${CATALINA_HOME}/bin/shutdown_pinpoint.sh > /dev/null &
    echo "SUCCESS :: Stopping WEBUI ..."
    ;;
  
  *)
    echo "Usage: $0 {start|stop}"
    ;;

esac
exit 1
